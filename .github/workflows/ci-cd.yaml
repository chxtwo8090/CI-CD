# .github/workflows/ci-cd.yml
name: EKS Infrastructure & Application CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'main.tf' # ì¸í”„ë¼ ë³€ê²½ ì‹œ Terraform ì‹¤í–‰
      - 'app/**' # ì• í”Œë¦¬ì¼€ì´ì…˜ ë³€ê²½ ì‹œ ë¹Œë“œ ë° ë°°í¬
      - 'kubernetes/**' # Kubernetes ë°°í¬ íŒŒì¼ ë³€ê²½ ì‹œ ë°°í¬
      - '.github/workflows/ci-cd.yaml' # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ ì‹œ ì‹¤í–‰

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: stock-analysis-eks-app
  EKS_CLUSTER_NAME: stock-analysis-eks

jobs:
  # 1. ì¸í”„ë¼ ë³€ê²½ ê°ì§€ ë° Terraform ë°°í¬
  terraform:
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    
    # main.tf íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: contains(github.event.head_commit.modified, 'main.tf') || contains(github.event.head_commit.added, 'main.tf')
    
    steps:
    - uses: actions/checkout@v4

    # 1.1 AWS ìê²© ì¦ëª… ì„¤ì • (GitHub Secretsì— ë“±ë¡ í•„ìˆ˜)
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    # 1.2 Terraform Init (S3 ë°±ì—”ë“œ ì„¤ì •)
    - name: Terraform Init
      run: |
        terraform init -backend-config="bucket=chxtwo-git" \
                       -backend-config="key=personal-project/eks/terraform.tfstate" \
                       -backend-config="region=${{ env.AWS_REGION }}" \
                       -backend-config="dynamodb_table=terraform-state-lock"

    # 1.3 Terraform Plan
    - name: Terraform Plan
      run: terraform plan -no-color

    # 1.4 Terraform Apply
    - name: Terraform Apply
      run: terraform apply -auto-approve

  # 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ, ECR í‘¸ì‹œ ë° EKS ë°°í¬
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    #needs: [terraform] # ì¸í”„ë¼ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ ì‹¤í–‰
    if: success()

    steps:
    - uses: actions/checkout@v4

    - name: Deploy to EKS # ğŸŒŸ ì´ 'Step'ì˜ ì´ë¦„
      run: | # ğŸŒŸ 'run:' ì•„ë˜ëŠ” Shell ëª…ë ¹ì–´ (Bash)
          # 1. ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì‚­ì œ (ALB ì „í™˜ì„ ìœ„í•œ ì´ˆê¸°í™”)
          kubectl delete service stock-analysis-service || true
          kubectl delete deployment stock-analysis-app || true 
          kubectl delete ingress stock-analysis-ingress || true
          
          # 2. ìƒˆë¡œìš´ ë¦¬ì†ŒìŠ¤ ì ìš©
          kubectl apply -f kubernetes/service.yaml # NodePort Service
          kubectl apply -f kubernetes/deployment.yaml
          kubectl apply -f kubernetes/ingress.yaml # Ingress ë¦¬ì†ŒìŠ¤


    # 2.1 AWS ìê²© ì¦ëª… ì„¤ì •
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # 2.2 ECR ë¡œê·¸ì¸
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # 2.3 ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }} # ì»¤ë°‹ SHAë¥¼ ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš©
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG app/
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    # 2.4 EKS ì„¤ì • (kubectl ì ‘ì†)
    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

    # 2.5 Kubernetes ë°°í¬ íŒŒì¼ ìˆ˜ì • (ìµœì‹  ì´ë¯¸ì§€ íƒœê·¸ ì ìš©)
    - name: Replace image tag in k8s deployment
      run: |
        ECR_URL="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}"
        sed -i "s|<ECR_URL>/stock-analysis-eks-app:latest|$ECR_URL:${{ github.sha }}|g" kubernetes/deployment.yaml

    # 2.6 Kubernetes ë°°í¬
    - name: Deploy to EKS
      run: |
        kubectl apply -f kubernetes/deployment.yaml
        kubectl apply -f kubernetes/service.yaml
